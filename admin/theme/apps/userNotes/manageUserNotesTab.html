<div class="row">
    <div class="col-md-12">
        <div class="pull-right">
            <button type="button" data-toggle="modal" data-target="#modal-add-notes" class="btn btn-info"><i class="fa fa-plus"></i> Add Note</button>
            <a href="/userNotes/" class="btn btn-info">Manage Notes</a>
        </div>
    </div>
</div>
<div class="table-responsive">
    <table class="table table-hover">
        <colgroup>
            <col width="10%"/>
            <col width="10%"/>
            <col width="15%"/>
            <col />
            <col width="80px"/>
        </colgroup>
        <thead>
            <tr>
                <th>Action</th>
                <th>Updated</th>
                <th>Updated By</th>
                <th>Description</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="notesTableBody">
            #if($userNotesSearchResults.hits.total == 0)

            #else
            #foreach($hit in $userNotesSearchResults.hits.hits)
            <tr>
                <td>
                    #if($hit.source.action.length() > 0)
                    <span class="label label-success">$hit.source.action</span>
                    #end
                </td>
                <td>$formatter.formatDateTime($formatter.parseDate($hit.source.modifiedDate))</td>
                #set($userUrl = '/manageUsers/' + $hit.source.modifiedBy)
                <td>$page.find($userUrl).thisProfile.formattedName</td>
                <td>
                    <a href="#" class="inlineEditNote" data-type="note" data-pk="1" data-value='{"title": "$formatter.format($hit.source.title)", "details": "$formatter.format($hit.source.details)"}' data-url="/_addUserNote/$hit.id" data-original-title="Edit Note"></a>
                </td>
                <td>
                    <a href="$hit.id" data-title="$hit.source.title" class="btn btn-sm btn-danger btn-remove-note"><i class="fa fa-trash"></i></a>
                </td>
            </tr>
            #end
            #end
        </tbody>
    </table>
</div>

<!-- create modal -->
<div id="modal-add-notes" class="modal modal-md fade" aria-hidden="true" tabindex="-1">
    <form action="/_addUserNote" method="POST" class="form-horizontal exclude">
        <input type="hidden" name="createNew" value="$page.userResource.href"/>
        <div class="modal-header">
            <button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
            <h4 class="modal-title">Create a new note</h4>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="col-md-2 control-label" for="template">Template</label>
                <div class="col-md-8">
                    <select class="form-control selectTemplate">
                        <option value="">Select a template</option>
                        #foreach($nt in $$userNotesTemplates)
                        <option value="$formatter.htmlAttEncode($nt.json)">$nt.jsonObject.templateTitle</option>
                        #end
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-2 control-label" for="title">Title</label>
                <div class="col-md-8">
                    <input class="form-control required" type="text" id="title" name="title" placeholder="Title" minlength="1" />
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-2 control-label" for="title">Action</label>
                <div class="col-md-8">
                    <select name="action" class="form-control" style="width: 100%">
                        <option></option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-2 control-label" for="details">Details</label>
                <div class="col-md-10">
                    <textarea class="form-control" placeholder="Details" name="details" rows="5"></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-sm btn-default" data-dismiss="modal" type="button">Close</button>
            <button type="button" class="btn btn-sm btn-primary" data-type="form-submit">Create</button>
        </div>
    </form>
</div>
<link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>
<link href="/theme/apps/userNotes/editable.notesEdit.css" rel="stylesheet" type="text/css"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js">//</script>
<script src="/theme/apps/userNotes/editable.notesEdit.js" type="text/javascript">//</script>
<script src="/theme/apps/userNotes/mustache.min.js" type="text/javascript">//</script>
<script>
    var extProfile = $formatter.toJson($profile);
    pageInitFunctions.push(function () {
        initManageUserNotesTab();
    });
    function initManageUserNotesTab() {
        var addModal = $('#modal-add-notes');
        var addForm = addModal.find('form');

        addForm.forms({
            callback: function (resp) {
                addModal.modal('hide');
                Msg.success('Successfully added note.');
                $('#notesTableBody').reloadFragment({
                    whenComplete: function () {
                        initInlineEditNotes();
                    }
                });
            }
        });

        addModal.on('change', '.selectTemplate', function (e) {
            e.preventDefault();

            var btn = $(this);
            var val = btn.val().trim();

            if (val.length > 0) {
                var json = JSON.parse(val);

                var title = json.title.trim();
                if (title.length > 0) {
                    var templatedTitle = Mustache.render(title, extProfile);
                    addForm.find('[name=title]').val(templatedTitle);
                }
                var details = json.details.trim();

                extProfile.now = moment().format('MMMM Do YYYY, h:mm:ss a');

                if (details.length > 0) {
                    var templatedDetails = Mustache.render(details, extProfile);
                    addForm.find('[name=details]').val(templatedDetails);
                }

                if (json.action.trim().length > 0) {
                    if ($('#modal-add-notes select[name=action]').find('[value="' + json.action + '"]').length === 0) {
                        $('#modal-add-notes select[name=action]').append('<option value="' + json.action + '">' + json.action + '</option>')
                    }
                }

                $('#modal-add-notes select[name=action]').select2('val', json.action);
            } else {
                addForm.find('[name=title]').val('');
                addForm.find('[name=details]').val('');
                $('#modal-add-notes select[name=action]').select2('val', '');
            }

        });

        $('body').on('hidden.bs.modal', '#modal-add-notes', function () {
            addForm.trigger('reset');
            $('#modal-add-notes select[name=action]').select2('val', '');
        });

        $('body').on('click', '.btn-remove-note', function (e) {
            e.preventDefault();

            var btn = $(this);
            var tr = btn.closest('tr');
            var href = '/_addUserNote/' + btn.attr('href');
            var title = '"' + btn.data('title') + '"';

            confirmDelete(href, title, function () {
                tr.remove();
            });
        });

        $('#modal-add-notes select[name=action]').select2({
            placeholder: "Select an action",
            tags: true,
            ajax: {// instead of writing the function to execute the request we use Select2's convenient helper
                url: '/userNotes/',
                dataType: 'json',
                quietMillis: 250,
                cache: false,
                data: function (term, page) {
                    flog('select2 - data', term);
                    return {
                        searchActions: 'searchActions',
                        q: term
                    };
                },
                processResults: function (data, page) {
                    return {
                        results: $.map(data.actions, function (obj) {
                            return {id: obj, text: obj};
                        })
                    };
                },
            }
        });
        initInlineEditNotes();
    }

    function initInlineEditNotes() {
        $('.inlineEditNote').editable({
            send: 'auto',
            validate: function (value) {
                if (value.title == '') {
                    return 'title is required!';
                }
                if (value.details == '') {
                    return 'details is required!';
                }
            },
            params: function (params) {
                params.editNote = true;
                params.title = params.value.title;
                params.details = params.value.details;
                return params;
            }
        });
    }
</script>